// Generated by CoffeeScript 1.6.3
(function() {
  var FeedManager;

  FeedManager = (function() {
    function FeedManager() {
      this.current_feed = 0;
      this.filter_read = true;
      this.get_current_feed();
      this.set_current_feed();
      this.buttons = {};
      this.bind(true, true);
    }

    FeedManager.prototype.update_title = function() {
      var el, feed, unread;
      feed = this.get_current_feed();
      el = $("#feed-" + feed);
      unread = el.children('small').text();
      return document.title = "" + unread + " " + (el.data('name'));
    };

    FeedManager.prototype.get_current_feed = function() {
      var hash;
      hash = Number(window.location.hash.slice(1));
      if (hash !== this.current_feed) {
        this.current_feed = hash;
        this.change_feed(this.current_feed);
      }
      return hash;
    };

    FeedManager.prototype.set_current_feed = function() {
      $(".feed-row.active").removeClass('active');
      $("#feed-" + this.current_feed).addClass('active');
      window.location.hash = this.current_feed;
      return this.update_title();
    };

    FeedManager.prototype.change_feed = function(feed, keep_active_article) {
      var tmp,
        _this = this;
      if (keep_active_article == null) {
        keep_active_article = false;
      }
      if (keep_active_article) {
        tmp = $('li.article-row.active').clone();
      }
      return $.ajax({
        url: "" + window.AJAX_BASE + "feeds/feeds/" + feed + "/articles",
        data: !this.filter_read ? 'all' : void 0,
        dataType: 'html',
        success: function(data) {
          _this.current_feed = feed;
          _this.set_current_feed();
          $('.article-list').html(data);
          if (keep_active_article) {
            $('div.article-list>ul').prepend(tmp);
          }
          return _this.bind();
        }
      });
    };

    FeedManager.prototype.update_unread = function(data) {
      var feed, _i, _len;
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        feed = data[_i];
        $("#feed-" + feed.feed + ">small").text("(" + feed.count + ")");
      }
      return this.update_title();
    };

    FeedManager.prototype.mark_read = function(article) {
      var _this = this;
      return $.ajax({
        url: "" + window.AJAX_BASE + "feeds/article/" + article + "/read",
        dataType: 'json',
        success: function(data) {
          $("#article-" + article).addClass('read');
          $("#article-" + article + ">div.article-content>div.article-content-footer>div>span:last").text('Mark unread');
          return _this.update_unread(data);
        }
      });
    };

    FeedManager.prototype.mark_unread = function(article) {
      var _this = this;
      return $.ajax({
        url: "" + window.AJAX_BASE + "feeds/article/" + article + "/unread",
        dataType: 'json',
        success: function(data) {
          $("#article-" + article).removeClass('read');
          $("#article-" + article + ">div.article-content>div.article-content-footer>div>span:last").text('Mark read');
          return _this.update_unread(data);
        }
      });
    };

    FeedManager.prototype.mark_all_read = function() {
      var feed,
        _this = this;
      feed = this.get_current_feed();
      return $.ajax({
        url: "" + window.AJAX_BASE + "feeds/feeds/" + feed + "/mark_read",
        dataType: 'json',
        success: function(data) {
          $('.article-row').addClass('read');
          if (feed === 0) {
            $('.feed-row>small').text('(0)');
          } else {
            $("#feed-" + feed + ">small").text('(0)');
          }
          $('li.article-row>div.article-content>div.article-content-footer>div>span:last').text('Mark unread');
          return _this.update_unread(data);
        }
      });
    };

    FeedManager.prototype.refresh_feed = function() {
      var feed,
        _this = this;
      feed = this.get_current_feed();
      $('#refresh-feed').addClass('disabled');
      return $.ajax({
        url: "" + window.AJAX_BASE + "feeds/feeds/" + feed + "/refresh",
        dataType: 'json',
        success: function(data) {
          _this.update_unread(data);
          _this.change_feed(feed, true);
          return $('#refresh-feed').removeClass('disabled');
        }
      });
    };

    FeedManager.prototype.toggle_filter_read = function() {
      this.filter_read = this.filter_read ^ 1;
      $('#filter-read').button('toggle');
      return this.change_feed(this.get_current_feed());
    };

    FeedManager.prototype.toggle_article = function(title, e) {
      var child, main_content, row,
        _this = this;
      if (e == null) {
        e = null;
      }
      row = title.parent();
      child = row.children('.article-content');
      main_content = child.children('.article-content-main');
      if (row.hasClass('active')) {
        child.css('display', 'none');
        row.removeClass('active');
      } else {
        $('li.article-row.active').each(function() {
          return $(this).removeClass('active').children('.article-content').css('display', 'none');
        });
        child.css('display', 'inline-block');
        row.addClass('active');
        if (!main_content.data('loaded')) {
          $.ajax({
            url: "" + window.AJAX_BASE + "feeds/article/" + (row.data('id')) + "/",
            dataType: 'json',
            success: function(data) {
              main_content.html(data.content);
              return main_content.data('loaded', true);
            }
          });
        }
        if (!row.hasClass('read')) {
          this.mark_read(row.data('id'));
        }
      }
      if (e != null) {
        e.stopPropagation();
        return e.preventDefault();
      }
    };

    FeedManager.prototype.next_article = function() {
      var current_article, next;
      current_article = $('.article-row.active');
      if (current_article.length === 0) {
        next = $('.article-row:first').children('.article-row-title');
      } else {
        next = current_article.next().children('.article-row-title');
      }
      if (next.length === 0) {
        return this.toggle_article(current_article.children('.article-row-title'));
      } else {
        return this.toggle_article(next);
      }
    };

    FeedManager.prototype.prev_article = function() {
      var current_article, prev;
      current_article = $('.article-row.active');
      if (current_article.length === 0) {
        return null;
      } else {
        prev = current_article.prev().children('.article-row-title');
      }
      if (prev.length === 0) {
        return this.toggle_article(current_article.children('.article-row-title'));
      } else {
        return this.toggle_article(prev);
      }
    };

    FeedManager.prototype.bind = function(feeds, initial) {
      var _this;
      if (feeds == null) {
        feeds = false;
      }
      if (initial == null) {
        initial = false;
      }
      _this = this;
      $('li.article-row>div.article-row-title').off('click');
      $('li.article-row>div.article-row-title').click(function(e) {
        return _this.toggle_article($(this), e);
      });
      $('li.article-row>div.article-content>div.article-content-footer>div').off('click');
      $('li.article-row>div.article-content>div.article-content-footer>div').click(function(e) {
        var id, row;
        row = $(this).parents('li');
        id = row.data('id');
        if (row.hasClass('read')) {
          return _this.mark_unread(id);
        } else {
          return _this.mark_read(id);
        }
      });
      if (feeds) {
        $('li.feed-row').off('click');
        $('li.feed-row').click(function(e) {
          var id, row;
          row = $(this);
          id = row.data('id');
          return _this.change_feed(id);
        });
      }
      if (initial) {
        this.buttons.mark_all_read = $('#mark-all-read');
        this.buttons.mark_all_read.click(function(e) {
          return _this.mark_all_read();
        });
        this.buttons.refresh_feed = $('#refresh-feed');
        this.buttons.refresh_feed.click(function(e) {
          return _this.refresh_feed();
        });
        this.buttons.filter_read = $('#filter-read');
        this.buttons.filter_read.click(function(e) {
          return _this.toggle_filter_read();
        });
        $('body').keyup(function(e) {
          if (e.which === 74) {
            return _this.next_article();
          } else if (e.which === 75) {
            return _this.prev_article();
          }
        });
        return this.change_feed(this.get_current_feed());
      }
    };

    return FeedManager;

  })();

  $(document).ready(function() {
    return window.feeds = new FeedManager();
  });

}).call(this);
