// Generated by CoffeeScript 1.6.2
(function() {
  var FeedManager;

  FeedManager = (function() {
    function FeedManager() {
      this.current_feed = 0;
      this.get_current_feed();
      this.set_current_feed();
      this.bind(true, true);
    }

    FeedManager.prototype.get_current_feed = function() {
      var hash;

      hash = Number(window.location.hash.slice(1));
      if (hash !== this.current_feed) {
        this.current_feed = hash;
        this.change_feed(this.current_feed);
      }
      return hash;
    };

    FeedManager.prototype.set_current_feed = function() {
      $(".feed-row.active").removeClass('active');
      $("#feed-" + this.current_feed).addClass('active');
      return window.location.hash = this.current_feed;
    };

    FeedManager.prototype.change_feed = function(feed) {
      var _this = this;

      return $.ajax({
        url: "/feeds/feeds/" + feed + "/articles",
        dataType: 'html',
        success: function(data) {
          _this.current_feed = feed;
          _this.set_current_feed();
          $('.article-list').html(data);
          return _this.bind();
        }
      });
    };

    FeedManager.prototype.update_unread = function(data) {
      var feed, _i, _len, _results;

      _results = [];
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        feed = data[_i];
        _results.push($("#feed-" + feed.feed + ">small").text("(" + feed.count + ")"));
      }
      return _results;
    };

    FeedManager.prototype.mark_read = function(article) {
      var _this = this;

      return $.ajax({
        url: "/feeds/article/" + article + "/read",
        dataType: 'json',
        success: function(data) {
          $("#article-" + article).addClass('read');
          return _this.update_unread(data);
        }
      });
    };

    FeedManager.prototype.mark_unread = function(article) {
      var _this = this;

      return $.ajax({
        url: "/feeds/article/" + article + "/unread",
        dataType: 'json',
        success: function(data) {
          $("#article-" + article).removeClass('read');
          return _this.update_unread(data);
        }
      });
    };

    FeedManager.prototype.mark_all_read = function() {
      var feed,
        _this = this;

      feed = this.get_current_feed();
      return $.ajax({
        url: "/feeds/feeds/" + feed + "/mark_read",
        dataType: 'json',
        success: function(data) {
          _this.update_unread(data);
          $('.article-row').addClass('read');
          if (feed === 0) {
            return $('.feed-row>small').text('(0)');
          } else {
            return $("#feed-" + feed.feed + ">small").text('(0)');
          }
        }
      });
    };

    FeedManager.prototype.refresh_feed = function() {
      var feed,
        _this = this;

      feed = this.get_current_feed();
      $('#refresh-feed').button('loading');
      return $.ajax({
        url: "/feeds/feeds/" + feed + "/refresh",
        dataType: 'json',
        success: function(data) {
          _this.update_unread(data);
          _this.change_feed(feed);
          return $('#refresh-feed').button('reset');
        }
      });
    };

    FeedManager.prototype.bind = function(feeds, initial) {
      var _this;

      if (feeds == null) {
        feeds = false;
      }
      if (initial == null) {
        initial = false;
      }
      _this = this;
      $('li.article-row>div.article-row-title').off('click');
      $('li.article-row>div.article-row-title').click(function(e) {
        var child, row, title;

        title = $(this);
        row = title.parent();
        child = title.next('.article-content');
        if (row.hasClass('active')) {
          child.css('display', 'none');
          row.removeClass('active');
        } else {
          $('li.article-row.active').each(function() {
            return $(this).removeClass('active').children('.article-content').css('display', 'none');
          });
          child.css('display', 'inline-block');
          row.addClass('active');
          if (!row.hasClass('read')) {
            _this.mark_read(row.data('id'));
          }
        }
        e.stopPropagation();
        return e.preventDefault();
      });
      if (feeds) {
        $('li.feed-row').off('click');
        $('li.feed-row').click(function(e) {
          var id, row;

          row = $(this);
          id = row.data('id');
          return _this.change_feed(id);
        });
      }
      if (initial) {
        $('#mark-all-as-read').click(function(e) {
          return _this.mark_all_read();
        });
        return $('#refresh-feed').click(function(e) {
          return _this.refresh_feed();
        });
      }
    };

    return FeedManager;

  })();

  $(document).ready(function() {
    return window.feeds = new FeedManager();
  });

}).call(this);
